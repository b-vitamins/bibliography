#!/bin/bash
# commit-msg hook to enforce standardized commit message format
# Based on guidelines in CLAUDE.md

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Skip merge commits and revert commits
if [[ "$commit_msg" =~ ^Merge || "$commit_msg" =~ ^Revert ]]; then
    exit 0
fi

# Define allowed prefixes based on CLAUDE.md examples
allowed_prefixes="^(feat|enhance|fix|refactor|doc|docs|chore|cleanup|test|style):"

# Check format: "prefix: description"
if [[ ! "$commit_msg" =~ $allowed_prefixes ]]; then
    echo "❌ Commit message format error!"
    echo ""
    echo "Expected format: <type>: <description>"
    echo ""
    echo "Allowed types:"
    echo "  feat:     New feature or functionality"
    echo "  enhance:  Improve existing feature (bibliographies, enrichment)"
    echo "  fix:      Bug fix or correction"
    echo "  refactor: Code structure changes without functionality change"
    echo "  doc:      Documentation updates"
    echo "  docs:     Documentation updates (alternative)"
    echo "  chore:    Maintenance tasks, dependency updates"
    echo "  cleanup:  Remove unused code, files, or data"
    echo "  test:     Add or modify tests"
    echo "  style:    Code style/formatting changes"
    echo ""
    echo "Examples from CLAUDE.md:"
    echo "  enhance: Enrich autoencoder.bib with PDF links and fixes"
    echo "  enhance: Update continual.bib with standardized bibkeys"
    echo "  fix: Correct duplicate abstract fields in ssm.bib"
    echo "  feat: Add streamlined entry enrichment workflow"
    echo "  refactor: Rename tracking file to shorter name"
    echo ""
    echo "Your message: $commit_msg"
    exit 1
fi

# Check message length (first line should be concise)
first_line=$(echo "$commit_msg" | head -n1)
if [[ ${#first_line} -gt 72 ]]; then
    echo "❌ Commit message too long!"
    echo "First line should be ≤72 characters, got ${#first_line}"
    echo "Your message: $first_line"
    exit 1
fi

# Reject "Generated by Claude Code" as per CLAUDE.md
if [[ "$commit_msg" =~ "Generated with.*Claude Code" ]]; then
    echo "❌ Remove 'Generated with Claude Code' footer"
    echo "CLAUDE.md: Do not add the 'Generated by Claude Code' comment"
    exit 1
fi

echo "✓ Commit message format validated"
exit 0